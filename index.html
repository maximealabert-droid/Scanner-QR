<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scanner QR2</title>

<style>
body {
  font-family: Arial, sans-serif;
  text-align: center;
  padding: 20px;
  background: #f4f6f8;
}

video {
  width: 100%;
  max-width: 350px;
  border-radius: 12px;
}

button {
  padding: 14px 20px;
  margin: 10px;
  font-size: 16px;
  border-radius: 8px;
  border: none;
  background: #0078D4;
  color: white;
  cursor: pointer;
}

ul {
  list-style: none;
  padding: 0;
  max-width: 400px;
  margin: 20px auto;
  text-align: left;
}

li {
  background: white;
  padding: 8px;
  margin-bottom: 6px;
  border-radius: 4px;
  font-size: 14px;
  word-break: break-all;
}
</style>
</head>

<body>

<h2>ðŸ“· Scanner QR2</h2>

<video id="video" muted playsinline></video>
<br>
<button onclick="startScanner()">DÃ©marrer Scan</button>
<button onclick="stopScanner()">Stop</button>

<h3>Historique</h3>
<ul id="history"></ul>

<script type="module">
import { BrowserQRCodeReader } from "https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.4/+esm";

let codeReader;
let selectedDeviceId;
const videoElement = document.getElementById('video');

async function startScanner() {
  codeReader = new BrowserQRCodeReader();

  const devices = await BrowserQRCodeReader.listVideoInputDevices();
  selectedDeviceId =
    devices.find(d => d.label.toLowerCase().includes("back"))?.deviceId
    || devices[0].deviceId;

  codeReader.decodeFromVideoDevice(selectedDeviceId, videoElement, (result, err) => {
    if (result) {
      const value = result.getText();
      saveToLocalStorage(value);
      alert("QR dÃ©tectÃ© : " + value);
      stopScanner();
      loadHistory();
    }
  });
}

function stopScanner() {
  if (codeReader) {
    codeReader.reset();
  }
}

function saveToLocalStorage(data) {
  let stored = JSON.parse(localStorage.getItem("qrHistory")) || [];
  stored.push({
    value: data,
    date: new Date().toLocaleString()
  });
  localStorage.setItem("qrHistory", JSON.stringify(stored));
}

function loadHistory() {
  let stored = JSON.parse(localStorage.getItem("qrHistory")) || [];
  const history = document.getElementById("history");
  history.innerHTML = "";

  stored.slice().reverse().forEach(item => {
    let li = document.createElement("li");
    li.textContent = item.date + " - " + item.value;
    history.appendChild(li);
  });
}

loadHistory();

window.startScanner = startScanner;
window.stopScanner = stopScanner;
</script>

</body>
</html>
