<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>QR Scanner iPhone</title>

<style>
body {
  font-family: Arial, sans-serif;
  text-align: center;
  padding: 20px;
  background: #f4f6f8;
}

video {
  width: 100%;
  max-width: 350px;
  border-radius: 10px;
}

button {
  padding: 12px 18px;
  margin: 10px;
  font-size: 16px;
  border-radius: 6px;
  border: none;
  background: #0078D4;
  color: white;
  cursor: pointer;
}

ul {
  list-style: none;
  padding: 0;
  max-width: 400px;
  margin: 20px auto;
  text-align: left;
}

li {
  background: white;
  padding: 8px;
  margin-bottom: 6px;
  border-radius: 4px;
  font-size: 14px;
  word-break: break-all;
}
</style>
</head>

<body>

<h2>ðŸ“· QR Scanner</h2>

<video id="video" autoplay playsinline></video>
<br>
<button onclick="startScanner()">DÃ©marrer Scan</button>
<button onclick="stopScanner()">Stop</button>

<h3>Historique</h3>
<ul id="history"></ul>

<script>
let video = document.getElementById("video");
let stream;
let detector;
let scanning = false;

async function startScanner() {
  if (!("BarcodeDetector" in window)) {
    alert("BarcodeDetector non supportÃ© sur cet iPhone.");
    return;
  }

  detector = new BarcodeDetector({ formats: ["qr_code"] });

  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" }
    });

    video.srcObject = stream;
    scanning = true;
    scanLoop();
  } catch (err) {
    alert("Erreur accÃ¨s camÃ©ra : " + err);
  }
}

async function scanLoop() {
  if (!scanning) return;

  try {
    const barcodes = await detector.detect(video);

    if (barcodes.length > 0) {
      const value = barcodes[0].rawValue;
      saveToLocalStorage(value);
      alert("QR dÃ©tectÃ© : " + value);
      stopScanner();
      loadHistory();
      return;
    }
  } catch (err) {
    console.error(err);
  }

  requestAnimationFrame(scanLoop);
}

function stopScanner() {
  scanning = false;
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
  }
}

function saveToLocalStorage(data) {
  let stored = JSON.parse(localStorage.getItem("qrHistory")) || [];
  stored.push({
    value: data,
    date: new Date().toLocaleString()
  });
  localStorage.setItem("qrHistory", JSON.stringify(stored));
}

function loadHistory() {
  let stored = JSON.parse(localStorage.getItem("qrHistory")) || [];
  const history = document.getElementById("history");
  history.innerHTML = "";

  stored.slice().reverse().forEach(item => {
    let li = document.createElement("li");
    li.textContent = item.date + " - " + item.value;
    history.appendChild(li);
  });
}

loadHistory();
</script>

</body>
</html>
